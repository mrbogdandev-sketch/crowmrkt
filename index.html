<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CrowMRKT</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #11100f;
            --bg-card: rgba(255,255,255,0.03);
            --bg-glass: rgba(255,255,255,0.06);
            --accent-primary: #ffd700;
            --accent-secondary: #ffed4e;
            --accent-tertiary: #fff9c4;
            --accent-gradient: linear-gradient(135deg, #ffd700, #ffed4e);
            --accent-gradient-glow: linear-gradient(135deg, #ffd700, #ffed4e, #fff9c4);
            --text-primary: #ffffff;
            --text-secondary: rgba(255,255,255,0.9);
            --text-muted: rgba(255,255,255,0.7);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border-radius: 20px;
            --border-radius-sm: 14px;
            --border-radius-lg: 24px;
            --shadow: 0 12px 40px rgba(0,0,0,0.5);
            --shadow-glow: 0 0 40px rgba(255,215,0,0.4);
            --shadow-glow-intense: 0 0 60px rgba(255,215,0,0.6);
            --transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(ellipse at 20% 10%, rgba(255,215,0,0.15) 0%, transparent 40%),
                radial-gradient(ellipse at 80% 90%, rgba(255,215,0,0.08) 0%, transparent 40%),
                linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        }

        .app {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
            min-height: 100vh;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 32px;
            border-bottom: 1px solid rgba(255,215,0,0.2);
            position: relative;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent-primary), transparent);
            opacity: 0.3;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 900;
            box-shadow: var(--shadow-glow);
            position: relative;
            overflow: hidden;
        }

        .logo-icon::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .logo-text h1 {
            font-size: 32px;
            font-weight: 900;
            background: var(--accent-gradient-glow);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255,215,0,0.3);
        }

        .logo-text p {
            font-size: 16px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 16px;
            background: var(--bg-glass);
            padding: 12px 20px;
            border-radius: var(--border-radius);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,215,0,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transition: var(--transition);
        }

        .user-profile:hover {
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-glow);
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-primary);
            box-shadow: 0 0 20px rgba(255,215,0,0.3);
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 700;
            font-size: 16px;
            color: var(--accent-tertiary);
        }

        .user-handle {
            font-size: 14px;
            color: var(--text-muted);
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 32px;
            background: var(--bg-glass);
            border-radius: var(--border-radius);
            padding: 8px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .nav-tab {
            flex: 1;
            padding: 14px 20px;
            background: transparent;
            border: none;
            border-radius: var(--border-radius-sm);
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            font-family: inherit;
            font-size: 15px;
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.08);
            color: var(--text-primary);
        }

        .nav-tab.active {
            background: rgba(255,215,0,0.15);
            color: var(--accent-primary);
            box-shadow: 0 4px 20px rgba(255,215,0,0.2);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--bg-glass);
            padding: 24px;
            border-radius: var(--border-radius);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,215,0,0.1), transparent);
            transition: left 0.8s;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card.income {
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,215,0,0.05));
            border-color: rgba(255,215,0,0.4);
        }

        .stat-card.income::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-gradient);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 8px;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            font-size: 16px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .stat-change {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }

        .positive {
            color: var(--accent-secondary);
        }

        /* Main Content */
        .content {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 28px;
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-glass);
            border-radius: var(--border-radius);
            padding: 28px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            height: fit-content;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .search-box {
            position: relative;
            margin-bottom: 24px;
        }

        .search-input {
            width: 100%;
            padding: 16px 20px 16px 52px;
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius-sm);
            color: var(--text-primary);
            font-size: 16px;
            transition: var(--transition);
            font-family: inherit;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(255,215,0,0.2);
            background: rgba(0,0,0,0.6);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent-primary);
        }

        .filter-section {
            margin-bottom: 28px;
        }

        .filter-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--accent-tertiary);
        }

        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            background: transparent;
            border: none;
            color: var(--text-primary);
            text-align: left;
            font-size: 15px;
            font-weight: 500;
        }

        .filter-option:hover {
            background: rgba(255,255,255,0.08);
            transform: translateX(4px);
        }

        .filter-option.active {
            background: rgba(255,215,0,0.15);
            color: var(--accent-primary);
            border-left: 3px solid var(--accent-primary);
        }

        .rarity-badge {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            flex-shrink: 0;
            box-shadow: 0 0 10px rgba(255,255,255,0.2);
        }

        .common { background: #6b7280; }
        .rare { background: #3b82f6; }
        .epic { background: #8b5cf6; }
        .legendary { background: var(--accent-primary); box-shadow: 0 0 15px rgba(255,215,0,0.5); }

        /* Marketplace */
        .marketplace-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 28px;
            font-weight: 800;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .view-controls {
            display: flex;
            gap: 10px;
        }

        .view-btn {
            padding: 10px 20px;
            background: var(--bg-glass);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius-sm);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            font-weight: 600;
        }

        .view-btn:hover {
            border-color: rgba(255,215,0,0.3);
        }

        .view-btn.active {
            background: rgba(255,215,0,0.15);
            color: var(--accent-primary);
            border-color: var(--accent-primary);
            box-shadow: 0 0 20px rgba(255,215,0,0.2);
        }

        .birds-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
        }

        .bird-card {
            background: var(--bg-glass);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--border-radius);
            padding: 24px;
            transition: var(--transition);
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .bird-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-gradient);
            transform: scaleX(0);
            transition: transform 0.4s;
        }

        .bird-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-glow-intense);
            border-color: rgba(255,215,0,0.4);
        }

        .bird-card:hover::before {
            transform: scaleX(1);
        }

        .bird-card.featured {
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-glow);
        }

        .bird-card.featured::before {
            transform: scaleX(1);
        }

        .bird-image {
            width: 100%;
            height: 160px;
            border-radius: var(--border-radius-sm);
            background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(255,215,0,0.05));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .bird-image::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, transparent 30%, rgba(255,215,0,0.1) 100%);
        }

        .bird-rarity {
            position: absolute;
            top: 16px;
            right: 16px;
            padding: 8px 16px;
            background: rgba(0,0,0,0.9);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .bird-info {
            margin-bottom: 20px;
        }

        .bird-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--accent-tertiary);
        }

        .bird-description {
            font-size: 15px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .bird-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-bottom: 20px;
        }

        .bird-stat {
            text-align: center;
            padding: 12px;
            background: rgba(0,0,0,0.4);
            border-radius: var(--border-radius-sm);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .stat-value-small {
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 4px;
        }

        .stat-label-small {
            font-size: 13px;
            color: var(--text-muted);
        }

        .bird-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: var(--border-radius-sm);
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: var(--transition);
            flex: 1;
            text-align: center;
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.6s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--accent-gradient);
            color: #000;
            font-weight: 800;
            box-shadow: 0 4px 20px rgba(255,215,0,0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .btn-secondary {
            background: var(--bg-glass);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,215,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Leaderboard */
        .leaderboard {
            background: var(--bg-glass);
            border-radius: var(--border-radius);
            padding: 28px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: rgba(0,0,0,0.3);
            border-radius: var(--border-radius-sm);
            transition: var(--transition);
        }

        .leaderboard-item:hover {
            background: rgba(255,255,255,0.08);
            transform: translateX(4px);
        }

        .leaderboard-item.current-user {
            background: rgba(255,215,0,0.15);
            border-left: 3px solid var(--accent-primary);
        }

        .leaderboard-rank {
            font-size: 18px;
            font-weight: 800;
            width: 32px;
            text-align: center;
            color: var(--accent-primary);
        }

        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-primary);
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .leaderboard-stats {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: var(--text-muted);
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: var(--border-radius-lg);
            padding: 40px;
            max-width: 520px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: var(--shadow-glow-intense);
            position: relative;
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-gradient);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-title {
            font-size: 28px;
            font-weight: 800;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 28px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--accent-primary);
            background: rgba(255,215,0,0.1);
        }

        .modal-body {
            margin-bottom: 30px;
        }

        .modal-bird-image {
            width: 100%;
            height: 200px;
            border-radius: var(--border-radius);
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,215,0,0.05));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 100px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .modal-bird-image::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, transparent 40%, rgba(255,215,0,0.1) 100%);
        }

        .modal-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 30px;
        }

        .detail-item {
            background: var(--bg-glass);
            border-radius: var(--border-radius-sm);
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .detail-value {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 6px;
        }

        .detail-label {
            font-size: 14px;
            color: var(--text-muted);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--bg-secondary);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: var(--border-radius);
            padding: 20px 24px;
            color: var(--text-primary);
            box-shadow: var(--shadow-glow);
            transform: translateY(100px);
            opacity: 0;
            transition: var(--transition);
            z-index: 1001;
            max-width: 400px;
            border-left: 4px solid var(--accent-primary);
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-left-color: var(--accent-primary);
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }

        .floating {
            animation: float 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .app {
                padding: 20px;
            }
            
            .content {
                grid-template-columns: 280px 1fr;
                gap: 24px;
            }
            
            .birds-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }

        @media (max-width: 968px) {
            .content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
            
            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .user-profile {
                align-self: stretch;
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .app {
                padding: 16px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .birds-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 24px;
                margin: 10px;
            }
            
            .modal-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">🐦</div>
                <div class="logo-text">
                    <h1>CrowMRKT</h1>
                    <p>Птичий рынок инвестиций</p>
                </div>
            </div>
            <div class="user-profile">
                <img id="userAvatar" class="user-avatar" alt="Avatar">
                <div class="user-info">
                    <div class="user-name" id="userName">Загрузка...</div>
                    <div class="user-handle" id="userHandle">@username</div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="marketplace">Рынок птиц</button>
            <button class="nav-tab" data-tab="collection">Моя коллекция</button>
            <button class="nav-tab" data-tab="leaderboard">Лидерборд</button>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="balance">100.00 CR</div>
                <div class="stat-label">Баланс кредитов</div>
                <div class="stat-change positive" id="balanceChange">+0.00 CR/сек</div>
            </div>
            <div class="stat-card income">
                <div class="stat-value" id="dailyIncome">0.00 CR</div>
                <div class="stat-label">Пассивный доход</div>
                <div class="stat-change" id="incomeChange">в сутки</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="birdsCount">0</div>
                <div class="stat-label">Птиц в коллекции</div>
                <div class="stat-change" id="portfolioValue">0.00 CR</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalEarned">0.00 CR</div>
                <div class="stat-label">Всего заработано</div>
                <div class="stat-change positive" id="sessionEarned">+0.00 CR</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="search-box">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path stroke="currentColor" stroke-width="2" stroke-linecap="round" d="M21 21l-4.35-4.35M11 6a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5z"/>
                    </svg>
                    <input type="text" class="search-input" id="searchInput" placeholder="Искать птиц...">
                </div>

                <div class="filter-section">
                    <div class="filter-title">Редкость</div>
                    <div class="filter-options">
                        <button class="filter-option active" data-rarity="all">
                            <div class="rarity-badge" style="background: var(--accent-primary)"></div>
                            <span>Все птицы</span>
                        </button>
                        <button class="filter-option" data-rarity="common">
                            <div class="rarity-badge common"></div>
                            <span>Обычные</span>
                        </button>
                        <button class="filter-option" data-rarity="rare">
                            <div class="rarity-badge rare"></div>
                            <span>Редкие</span>
                        </button>
                        <button class="filter-option" data-rarity="epic">
                            <div class="rarity-badge epic"></div>
                            <span>Эпические</span>
                        </button>
                        <button class="filter-option" data-rarity="legendary">
                            <div class="rarity-badge legendary"></div>
                            <span>Легендарные</span>
                        </button>
                    </div>
                </div>

                <div class="filter-section">
                    <div class="filter-title">Сортировка</div>
                    <div class="filter-options">
                        <button class="filter-option active" data-sort="price-asc">
                            <span>Цена: по возрастанию</span>
                        </button>
                        <button class="filter-option" data-sort="price-desc">
                            <span>Цена: по убыванию</span>
                        </button>
                        <button class="filter-option" data-sort="income-desc">
                            <span>Доход: высокий → низкий</span>
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Marketplace -->
            <main class="marketplace" id="marketplaceTab">
                <div class="marketplace-header">
                    <h2 class="section-title" id="sectionTitle">Рынок птиц</h2>
                    <div class="view-controls">
                        <button class="view-btn active" data-view="grid">Сетка</button>
                        <button class="view-btn" data-view="list">Список</button>
                    </div>
                </div>

                <div class="birds-grid" id="birdsGrid">
                    <!-- Birds will be loaded here -->
                </div>
            </main>

            <!-- Collection -->
            <main class="marketplace" id="collectionTab" style="display: none;">
                <div class="marketplace-header">
                    <h2 class="section-title">Моя коллекция</h2>
                    <div class="view-controls">
                        <button class="view-btn active" data-view="grid">Сетка</button>
                        <button class="view-btn" data-view="list">Список</button>
                    </div>
                </div>

                <div class="birds-grid" id="collectionGrid">
                    <!-- Collection birds will be loaded here -->
                </div>
            </main>

            <!-- Leaderboard -->
            <main class="leaderboard" id="leaderboardTab" style="display: none;">
                <div class="marketplace-header">
                    <h2 class="section-title">Лидерборд</h2>
                    <div class="view-controls">
                        <button class="view-btn active" data-period="daily">За день</button>
                        <button class="view-btn" data-period="weekly">За неделю</button>
                        <button class="view-btn" data-period="alltime">За всё время</button>
                    </div>
                </div>

                <div class="leaderboard-list" id="leaderboardList">
                    <!-- Leaderboard will be loaded here -->
                </div>
            </main>
        </div>
    </div>

    <!-- Purchase Modal -->
    <div class="modal" id="purchaseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Покупка птицы</h3>
                <button class="modal-close" id="closeModal">×</button>
            </div>
            <div class="modal-body">
                <div class="modal-bird-image" id="modalBirdImage">🐦</div>
                
                <h4 id="modalBirdName" style="margin-bottom: 12px; color: var(--accent-tertiary);">Название птицы</h4>
                <p style="color: var(--text-secondary); margin-bottom: 30px; font-size: 16px; line-height: 1.5;" id="modalBirdDescription">Описание птицы</p>
                
                <div class="modal-details">
                    <div class="detail-item">
                        <div class="detail-value" style="color: var(--accent-primary);" id="modalBirdPrice">0 CR</div>
                        <div class="detail-label">Цена покупки</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-value" style="color: var(--success);" id="modalBirdIncome">0 CR/день</div>
                        <div class="detail-label">Пассивный доход</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-value" id="modalBirdRarity">Обычная</div>
                        <div class="detail-label">Редкость</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-value" style="color: var(--accent-secondary);" id="modalROI">0 дней</div>
                        <div class="detail-label">Окупаемость</div>
                    </div>
                </div>

                <div class="bird-actions">
                    <button class="btn btn-secondary" id="cancelPurchase">Отмена</button>
                    <button class="btn btn-primary" id="confirmPurchase">
                        <span id="purchaseText">Купить за 0 CR</span>
                        <span class="loading" id="purchaseLoading" style="display: none;"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ==================== CONFIGURATION ====================
        const BIRDS_DATA = [
            {
                id: 1, name: 'Грач-инвестор', rarity: 'epic', price: 120.00, 
                dailyIncome: 6.40, emoji: '💰', 
                description: 'Величественная птица, приносящая стабильный доход. Идеальное начало вашей коллекции.',
                featured: true
            },
            {
                id: 2, name: 'Солнечный воробей', rarity: 'common', price: 12.00, 
                dailyIncome: 0.40, emoji: '🌞', 
                description: 'Маленькая, но энергичная птица, приносящая первые лучи дохода.'
            },
            {
                id: 3, name: 'Огненный феникс', rarity: 'rare', price: 55.00, 
                dailyIncome: 2.10, emoji: '🔥', 
                description: 'Мифическая птица, возрождающая ваш капитал с новой силой.'
            },
            {
                id: 4, name: 'Лунная сова', rarity: 'epic', price: 200.00, 
                dailyIncome: 9.00, emoji: '🌙', 
                description: 'Мудрая птица, работающая в тишине ночи для вашего богатства.'
            },
            {
                id: 5, name: 'Серебряный голубь', rarity: 'common', price: 9.00, 
                dailyIncome: 0.28, emoji: '🕊️', 
                description: 'Элегантная птица, приносящая стабильный, хоть и небольшой доход.'
            },
            {
                id: 6, name: 'Изумрудный попугай', rarity: 'rare', price: 78.00, 
                dailyIncome: 3.20, emoji: '🦜', 
                description: 'Яркая птица, чьи инвестиции всегда оказываются удачными.'
            },
            {
                id: 7, name: 'Бриллиантовый орёл', rarity: 'common', price: 15.00, 
                dailyIncome: 0.55, emoji: '🦅', 
                description: 'Гордая птица, парящая над финансовыми вершинами.'
            },
            {
                id: 8, name: 'Рубиновый колибри', rarity: 'rare', price: 64.00, 
                dailyIncome: 2.55, emoji: '❤️', 
                description: 'Быстрая и эффективная птица для мгновенного дохода.'
            },
            {
                id: 9, name: 'Платиновый павлин', rarity: 'epic', price: 350.00, 
                dailyIncome: 17.8, emoji: '🦚', 
                description: 'Роскошная птица, демонстрирующая ваш успех в мире инвестиций.',
                featured: true
            },
            {
                id: 10, name: 'Легенда изобилия', rarity: 'legendary', price: 800.00, 
                dailyIncome: 45.0, emoji: '🏆', 
                description: 'Величайшая птица в коллекции, источник неиссякаемого богатства.',
                featured: true
            },
            {
                id: 11, name: 'Аметистовый фламинго', rarity: 'rare', price: 95.00, 
                dailyIncome: 4.20, emoji: '🦩', 
                description: 'Элегантная птица, приносящая доход с изяществом и стилем.'
            },
            {
                id: 12, name: 'Сапфировый зимородок', rarity: 'epic', price: 280.00, 
                dailyIncome: 12.5, emoji: '🔵', 
                description: 'Редкая птица, чей доход чист и прозрачен как сапфир.'
            },
            {
                id: 13, name: 'Топазовый тукан', rarity: 'common', price: 22.00, 
                dailyIncome: 0.85, emoji: '🦜', 
                description: 'Яркая птица с большим клювом для сбора прибыли.'
            },
            {
                id: 14, name: 'Опаловый пеликан', rarity: 'rare', price: 110.00, 
                dailyIncome: 5.10, emoji: '🦢', 
                description: 'Птица с вместительным клювом для хранения ваших доходов.'
            },
            {
                id: 15, name: 'Изумрудный кетцаль', rarity: 'legendary', price: 1200.00, 
                dailyIncome: 68.0, emoji: '💎', 
                description: 'Священная птица древних цивилизаций, приносящая невероятное богатство.',
                featured: true
            }
        ];

        // ==================== STATE MANAGEMENT ====================
        const state = {
            user: null,
            balance: 100.00,
            ownedBirds: [],
            totalEarned: 0,
            sessionEarned: 0,
            filters: { search: '', rarity: 'all', sort: 'price-asc' },
            selectedBird: null,
            lastUpdate: Date.now(),
            activeTab: 'marketplace'
        };

        // ==================== TELEGRAM INTEGRATION ====================
        const tg = window.Telegram?.WebApp;

        function initTelegram() {
            if (tg) {
                tg.expand();
                tg.enableClosingConfirmation();
                tg.setHeaderColor('#ffd700');
                tg.setBackgroundColor('#0a0a0a');
                
                const user = tg.initDataUnsafe?.user;
                if (user) {
                    state.user = user;
                    updateUserProfile(user);
                    loadUserData();
                }
            } else {
                // Demo mode
                state.user = {
                    id: 'demo_user_' + Date.now(),
                    first_name: 'Инвестор',
                    username: 'bird_investor',
                    photo_url: ''
                };
                updateUserProfile(state.user);
                loadUserData();
            }
        }

        function updateUserProfile(user) {
            const avatar = document.getElementById('userAvatar');
            const name = document.getElementById('userName');
            const handle = document.getElementById('userHandle');
            
            if (user.photo_url) {
                avatar.src = user.photo_url;
                avatar.onerror = () => {
                    avatar.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjQiIGN5PSIyNCIgcj0iMjQiIGZpbGw9IiNmZmQ3MDAiIG9wYWNpdHk9IjAuMiIvPgo8Y2lyY2xlIGN4PSIyNCIgY3k9IjE4IiByPSI2IiBmaWxsPSIjZmZkNzAwIi8+CjxwYXRoIGQ9Ik0zNiAzNEMzNiAzMC42ODYzIDMwLjYyNjQgMjYgMjQgMjZDNy4zNzM2IDI2IDIgMzAuNjg2MyAyIDM0QzIgMzcuMzEzNyA3LjM3MzYgNDIgMjQgNDJDMzAuNjI2NCA0MiAzNiAzNy4zMTM3IDM2IDM0WiIgZmlsbD0iI2ZmZDcwMCIvPgo8L3N2Zz4K';
                };
            } else {
                avatar.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjQiIGN5PSIyNCIgcj0iMjQiIGZpbGw9IiNmZmQ3MDAiIG9wYWNpdHk9IjAuMiIvPgo8Y2lyY2xlIGN4PSIyNCIgY3k9IjE4IiByPSI2IiBmaWxsPSIjZmZkNzAwIi8+CjxwYXRoIGQ9Ik0zNiAzNEMzNiAzMC42ODYzIDMwLjYyNjQgMjYgMjQgMjZDNy4zNzM2IDI2IDIgMzAuNjg2MyAyIDM0QzIgMzcuMzEzNyA3LjM3MzYgNDIgMjQgNDJDMzAuNjI2NCA0MiAzNiAzNy4zMTM3IDM2IDM0WiIgZmlsbD0iI2ZmZDcwMCIvPgo8L3N2Zz4K';
            }
            
            name.textContent = user.first_name || 'Птичий инвестор';
            handle.textContent = user.username ? `@${user.username}` : 'CrowMRKT';
        }

        // ==================== DATA MANAGEMENT ====================
        function loadUserData() {
            if (!state.user) return;
            
            const storageKey = `crowmrkt_${state.user.id || 'demo'}`;
            const saved = localStorage.getItem(storageKey);
            
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    state.balance = data.balance || 100.00;
                    state.ownedBirds = data.ownedBirds || [];
                    state.totalEarned = data.totalEarned || 0;
                } catch (e) {
                    console.error('Error loading saved data:', e);
                }
            }
            
            updateUI();
            startIncomeTimer();
            saveUserDataToServer();
        }

        function saveUserData() {
            if (!state.user) return;
            
            const storageKey = `crowmrkt_${state.user.id || 'demo'}`;
            const data = {
                balance: state.balance,
                ownedBirds: state.ownedBirds,
                totalEarned: state.totalEarned,
                lastSave: Date.now()
            };
            
            localStorage.setItem(storageKey, JSON.stringify(data));
            saveUserDataToServer();
        }

        // Simulate saving to server (in a real app, this would be an API call)
        function saveUserDataToServer() {
            if (!state.user) return;
            
            // In a real app, this would be an API call to save to users.json
            console.log('Saving user data to server...', {
                userId: state.user.id,
                balance: state.balance,
                ownedBirds: state.ownedBirds.length,
                totalEarned: state.totalEarned
            });
            
            // Simulate API call
            setTimeout(() => {
                console.log('User data saved successfully');
            }, 500);
        }

        // ==================== GAME LOGIC ====================
        function calculateDailyIncome() {
            return state.ownedBirds.reduce((total, birdId) => {
                const bird = BIRDS_DATA.find(b => b.id === birdId);
                return total + (bird ? bird.dailyIncome : 0);
            }, 0);
        }

        function calculatePortfolioValue() {
            return state.ownedBirds.reduce((total, birdId) => {
                const bird = BIRDS_DATA.find(b => b.id === birdId);
                return total + (bird ? bird.price * 0.8 : 0); // 80% от стоимости
            }, 0);
        }

        // ==================== UI UPDATES ====================
        function updateUI() {
            const dailyIncome = calculateDailyIncome();
            const portfolioValue = calculatePortfolioValue();
            const perSecond = dailyIncome / 86400;
            
            // Update stats
            document.getElementById('balance').textContent = state.balance.toFixed(2) + ' CR';
            document.getElementById('dailyIncome').textContent = dailyIncome.toFixed(2) + ' CR';
            document.getElementById('birdsCount').textContent = state.ownedBirds.length;
            document.getElementById('totalEarned').textContent = state.totalEarned.toFixed(2) + ' CR';
            document.getElementById('portfolioValue').textContent = portfolioValue.toFixed(2) + ' CR';
            document.getElementById('balanceChange').textContent = `+${perSecond.toFixed(4)} CR/сек`;
            document.getElementById('sessionEarned').textContent = `+${state.sessionEarned.toFixed(2)} CR`;
            
            if (state.activeTab === 'marketplace') {
                renderBirdsGrid();
            } else if (state.activeTab === 'collection') {
                renderCollectionGrid();
            } else if (state.activeTab === 'leaderboard') {
                renderLeaderboard();
            }
        }

        function renderBirdsGrid() {
            const grid = document.getElementById('birdsGrid');
            let filteredBirds = BIRDS_DATA.filter(bird => {
                // Search filter
                if (state.filters.search) {
                    const searchTerm = state.filters.search.toLowerCase();
                    if (!bird.name.toLowerCase().includes(searchTerm) && 
                        !bird.description.toLowerCase().includes(searchTerm)) {
                        return false;
                    }
                }
                
                // Rarity filter
                if (state.filters.rarity !== 'all' && bird.rarity !== state.filters.rarity) {
                    return false;
                }
                
                return true;
            });
            
            // Sort birds
            filteredBirds.sort((a, b) => {
                switch (state.filters.sort) {
                    case 'price-desc': return b.price - a.price;
                    case 'income-desc': return b.dailyIncome - a.dailyIncome;
                    case 'price-asc':
                    default: return a.price - b.price;
                }
            });
            
            grid.innerHTML = filteredBirds.map(bird => {
                const isOwned = state.ownedBirds.includes(bird.id);
                const canAfford = state.balance >= bird.price;
                const rarityLabel = getRarityLabel(bird.rarity);
                const rarityClass = bird.rarity;
                
                return `
                    <div class="bird-card ${bird.featured ? 'featured' : ''}">
                        <div class="bird-image floating">
                            ${bird.emoji}
                            <div class="bird-rarity ${rarityClass}">${rarityLabel}</div>
                        </div>
                        <div class="bird-info">
                            <div class="bird-name">${bird.name}</div>
                            <div class="bird-description">${bird.description}</div>
                            <div class="bird-stats">
                                <div class="bird-stat">
                                    <div class="stat-value-small" style="color: var(--accent-primary);">${bird.price.toFixed(2)} CR</div>
                                    <div class="stat-label-small">Инвестиция</div>
                                </div>
                                <div class="bird-stat">
                                    <div class="stat-value-small" style="color: var(--success);">+${bird.dailyIncome.toFixed(2)} CR</div>
                                    <div class="stat-label-small">В день</div>
                                </div>
                            </div>
                        </div>
                        <div class="bird-actions">
                            ${isOwned ? 
                                '<button class="btn btn-secondary" disabled>✓ В коллекции</button>' :
                                `<button class="btn btn-primary ${!canAfford ? 'disabled' : ''}" 
                                 data-bird-id="${bird.id}" 
                                 ${!canAfford ? 'disabled' : ''}>
                                    ${canAfford ? `Инвестировать ${bird.price.toFixed(2)} CR` : 'Недостаточно'}
                                </button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add event listeners
            document.querySelectorAll('.btn-primary:not(.disabled)').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const birdId = parseInt(e.target.dataset.birdId);
                    openPurchaseModal(birdId);
                });
            });
        }

        function renderCollectionGrid() {
            const grid = document.getElementById('collectionGrid');
            const ownedBirds = BIRDS_DATA.filter(bird => state.ownedBirds.includes(bird.id));
            
            if (ownedBirds.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px;">
                        <div style="font-size: 80px; margin-bottom: 20px;">🐦</div>
                        <h3 style="color: var(--text-muted); margin-bottom: 16px;">Коллекция пуста</h3>
                        <p style="color: var(--text-muted);">Приобретите птиц на рынке, чтобы начать зарабатывать</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = ownedBirds.map(bird => {
                const rarityLabel = getRarityLabel(bird.rarity);
                const rarityClass = bird.rarity;
                
                return `
                    <div class="bird-card ${bird.featured ? 'featured' : ''}">
                        <div class="bird-image floating">
                            ${bird.emoji}
                            <div class="bird-rarity ${rarityClass}">${rarityLabel}</div>
                        </div>
                        <div class="bird-info">
                            <div class="bird-name">${bird.name}</div>
                            <div class="bird-description">${bird.description}</div>
                            <div class="bird-stats">
                                <div class="bird-stat">
                                    <div class="stat-value-small" style="color: var(--accent-primary);">${bird.price.toFixed(2)} CR</div>
                                    <div class="stat-label-small">Стоимость</div>
                                </div>
                                <div class="bird-stat">
                                    <div class="stat-value-small" style="color: var(--success);">+${bird.dailyIncome.toFixed(2)} CR</div>
                                    <div class="stat-label-small">В день</div>
                                </div>
                            </div>
                        </div>
                        <div class="bird-actions">
                            <button class="btn btn-secondary" disabled>✓ В коллекции</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderLeaderboard() {
            const list = document.getElementById('leaderboardList');
            
            // Generate mock leaderboard data
            const leaderboardData = [
                { id: state.user.id, name: state.user.first_name, username: state.user.username, photo_url: state.user.photo_url, totalEarned: state.totalEarned, rank: 1 },
                { id: 'user2', name: 'Алексей', username: 'alex_bird', photo_url: '', totalEarned: 2450.75, rank: 2 },
                { id: 'user3', name: 'Мария', username: 'maria_invest', photo_url: '', totalEarned: 1980.30, rank: 3 },
                { id: 'user4', name: 'Дмитрий', username: 'dima_bird', photo_url: '', totalEarned: 1650.20, rank: 4 },
                { id: 'user5', name: 'Елена', username: 'elena_collector', photo_url: '', totalEarned: 1420.80, rank: 5 },
                { id: 'user6', name: 'Сергей', username: 'serg_bird', photo_url: '', totalEarned: 1250.50, rank: 6 },
                { id: 'user7', name: 'Ольга', username: 'olga_invest', photo_url: '', totalEarned: 980.25, rank: 7 },
                { id: 'user8', name: 'Иван', username: 'ivan_collector', photo_url: '', totalEarned: 750.40, rank: 8 },
                { id: 'user9', name: 'Анна', username: 'anna_bird', photo_url: '', totalEarned: 520.10, rank: 9 },
                { id: 'user10', name: 'Павел', username: 'pavel_invest', photo_url: '', totalEarned: 320.75, rank: 10 }
            ];
            
            list.innerHTML = leaderboardData.map(user => `
                <div class="leaderboard-item ${user.id === state.user.id ? 'current-user' : ''}">
                    <div class="leaderboard-rank">#${user.rank}</div>
                    <img class="leaderboard-avatar" src="${user.photo_url || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjQiIGN5PSIyNCIgcj0iMjQiIGZpbGw9IiNmZmQ3MDAiIG9wYWNpdHk9IjAuMiIvPgo8Y2lyY2xlIGN4PSIyNCIgY3k9IjE4IiByPSI2IiBmaWxsPSIjZmZkNzAwIi8+CjxwYXRoIGQ9Ik0zNiAzNEMzNiAzMC42ODYzIDMwLjYyNjQgMjYgMjQgMjZDNy4zNzM2IDI2IDIgMzAuNjg2MyAyIDM0QzIgMzcuMzEzNyA3LjM3MzYgNDIgMjQgNDJDMzAuNjI2NCA0MiAzNiAzNy4zMTM3IDM2IDM0WiIgZmlsbD0iI2ZmZDcwMCIvPgo8L3N2Zz4K'}" alt="${user.name}">
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">${user.name}</div>
                        <div class="leaderboard-stats">
                            <span>@${user.username}</span>
                            <span>${user.totalEarned.toFixed(2)} CR</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getRarityLabel(rarity) {
            const labels = {
                common: 'Обычная',
                rare: 'Редкая', 
                epic: 'Эпическая',
                legendary: 'Легендарная'
            };
            return labels[rarity] || rarity;
        }

        // ==================== TAB MANAGEMENT ====================
        function switchTab(tabName) {
            state.activeTab = tabName;
            
            // Update active tab button
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            
            // Show/hide tab content
            document.getElementById('marketplaceTab').style.display = tabName === 'marketplace' ? 'block' : 'none';
            document.getElementById('collectionTab').style.display = tabName === 'collection' ? 'block' : 'none';
            document.getElementById('leaderboardTab').style.display = tabName === 'leaderboard' ? 'block' : 'none';
            
            // Update UI for the active tab
            updateUI();
        }

        // ==================== MODAL FUNCTIONS ====================
        function openPurchaseModal(birdId) {
            const bird = BIRDS_DATA.find(b => b.id === birdId);
            if (!bird) return;
            
            state.selectedBird = bird;
            
            const modal = document.getElementById('purchaseModal');
            const roi = Math.ceil(bird.price / bird.dailyIncome);
            
            document.getElementById('modalBirdImage').textContent = bird.emoji;
            document.getElementById('modalBirdName').textContent = bird.name;
            document.getElementById('modalBirdDescription').textContent = bird.description;
            document.getElementById('modalBirdPrice').textContent = bird.price.toFixed(2) + ' CR';
            document.getElementById('modalBirdIncome').textContent = '+' + bird.dailyIncome.toFixed(2) + ' CR/день';
            document.getElementById('modalBirdRarity').textContent = getRarityLabel(bird.rarity);
            document.getElementById('modalROI').textContent = `${roi} дней`;
            document.getElementById('purchaseText').textContent = `Инвестировать ${bird.price.toFixed(2)} CR`;
            
            modal.classList.add('active');
        }

        function closePurchaseModal() {
            const modal = document.getElementById('purchaseModal');
            modal.classList.remove('active');
            state.selectedBird = null;
        }

        async function purchaseBird() {
            if (!state.selectedBird) return;
            
            const bird = state.selectedBird;
            const purchaseBtn = document.getElementById('confirmPurchase');
            const purchaseText = document.getElementById('purchaseText');
            const purchaseLoading = document.getElementById('purchaseLoading');
            
            // Show loading
            purchaseText.style.display = 'none';
            purchaseLoading.style.display = 'inline-block';
            purchaseBtn.disabled = true;
            
            // Simulate API call delay
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            if (state.balance < bird.price) {
                showToast('❌ Недостаточно кредитов для инвестиции!', 'error');
                purchaseText.style.display = 'inline-block';
                purchaseLoading.style.display = 'none';
                purchaseBtn.disabled = false;
                return;
            }
            
            if (state.ownedBirds.includes(bird.id)) {
                showToast('⚠️ Эта птица уже в вашей коллекции!', 'error');
                purchaseText.style.display = 'inline-block';
                purchaseLoading.style.display = 'none';
                purchaseBtn.disabled = false;
                return;
            }
            
            // Process purchase
            state.balance -= bird.price;
            state.ownedBirds.push(bird.id);
            
            // Give purchase bonus
            const bonus = bird.dailyIncome * 0.5;
            state.totalEarned += bonus;
            state.sessionEarned += bonus;
            
            // Save and update
            saveUserData();
            updateUI();
            closePurchaseModal();
            
            showToast(`🎉 Успех! Вы приобрели ${bird.name}! +${bird.dailyIncome.toFixed(2)} CR/день`, 'success');
            
            // Restore button
            purchaseText.style.display = 'inline-block';
            purchaseLoading.style.display = 'none';
            purchaseBtn.disabled = false;
        }

        // ==================== TOAST NOTIFICATIONS ====================
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        // ==================== INCOME TIMER ====================
        function startIncomeTimer() {
            setInterval(() => {
                const now = Date.now();
                const deltaTime = (now - state.lastUpdate) / 1000; // in seconds
                state.lastUpdate = now;
                
                const dailyIncome = calculateDailyIncome();
                const perSecond = dailyIncome / 86400;
                const earned = perSecond * deltaTime;
                
                state.balance += earned;
                state.totalEarned += earned;
                state.sessionEarned += earned;
                
                updateUI();
                
                // Auto-save every 30 seconds
                if (Math.floor(now / 1000) % 30 === 0) {
                    saveUserData();
                }
            }, 1000);
        }

        // ==================== EVENT LISTENERS ====================
        function initEventListeners() {
            // Search
            document.getElementById('searchInput').addEventListener('input', (e) => {
                state.filters.search = e.target.value;
                renderBirdsGrid();
            });
            
            // Rarity filters
            document.querySelectorAll('.filter-option[data-rarity]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-option[data-rarity]').forEach(b => {
                        b.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    state.filters.rarity = e.target.dataset.rarity;
                    renderBirdsGrid();
                });
            });
            
            // Sort filters
            document.querySelectorAll('.filter-option[data-sort]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-option[data-sort]').forEach(b => {
                        b.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    state.filters.sort = e.target.dataset.sort;
                    renderBirdsGrid();
                });
            });
            
            // View controls
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.view-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    // View change logic can be added here
                });
            });
            
            // Tab controls
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    switchTab(e.target.dataset.tab);
                });
            });
            
            // Modal controls
            document.getElementById('closeModal').addEventListener('click', closePurchaseModal);
            document.getElementById('cancelPurchase').addEventListener('click', closePurchaseModal);
            document.getElementById('confirmPurchase').addEventListener('click', purchaseBird);
            
            // Close modal on backdrop click
            document.getElementById('purchaseModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('purchaseModal')) {
                    closePurchaseModal();
                }
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closePurchaseModal();
                }
            });
        }

        // ==================== INITIALIZATION ====================
        function initApp() {
            initTelegram();
            initEventListeners();
            switchTab('marketplace');
            
            // Auto-save on page unload
            window.addEventListener('beforeunload', saveUserData);
            
            showToast('🌟 Добро пожаловать в мир птичьих инвестиций!', 'success');
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
