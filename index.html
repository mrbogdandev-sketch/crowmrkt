<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>CrowMRKT — Птичий рынок пассивного дохода</title>
  <meta name="description" content="CrowMRKT — покупай птиц, получай пассивный доход в Telegram Mini App" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-1: #0a0a0a;
      --bg-2: #11100f;
      --bg-3: #1a1918;
      --accent: #ff7a18;
      --accent-gradient: linear-gradient(135deg, #ff7a18, #ff5500);
      --accent-light: #ffb86b;
      --text-primary: #ffffff;
      --text-secondary: rgba(255,255,255,0.7);
      --text-muted: rgba(255,255,255,0.5);
      --glass-1: rgba(255,255,255,0.03);
      --glass-2: rgba(255,255,255,0.05);
      --glass-border: rgba(255,255,255,0.08);
      --success: #10b981;
      --danger: #ef4444;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --shadow-1: 0 4px 12px rgba(0,0,0,0.3);
      --shadow-2: 0 8px 24px rgba(0,0,0,0.4);
      --shadow-glow: 0 0 20px rgba(255,122,24,0.15);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-1);
      color: var(--text-primary);
      overflow-x: hidden;
      position: relative;
    }

    body {
      background: 
        radial-gradient(ellipse at 20% 20%, rgba(255,122,24,0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(255,122,24,0.05) 0%, transparent 50%),
        linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 100%);
      min-height: 100vh;      
      padding: 0;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      padding: 12px 16px;
      background: rgba(10, 10, 10, 0.9);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-md);
      background: var(--accent-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 18px;
      color: #000;
    }

    .logo-text h1 {
      font-size: 18px;
      font-weight: 700;
    }

    .logo-text p {
      font-size: 12px;
      color: var(--text-muted);
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--glass-border);
    }

    .user-info {
      display: none;
    }

    @media (min-width: 768px) {
      .user-info {
        display: block;
      }
      
      .user-name {
        font-weight: 600;
        font-size: 14px;
      }
      
      .user-handle {
        font-size: 12px;
        color: var(--text-muted);
      }
    }

    /* Main Layout */
    .app-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      padding: 16px;
    }

    /* Stats Panel */
    .stats-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--glass-1);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 16px;
      backdrop-filter: blur(10px);
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-muted);
    }

    .income-stat {
      background: linear-gradient(135deg, rgba(255,122,24,0.1), rgba(255,122,24,0.05));
      border-color: rgba(255,122,24,0.2);
    }

    /* Content Layout */
    .content {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }

    @media (min-width: 1024px) {
      .content {
        grid-template-columns: 280px 1fr;
      }
    }

    /* Sidebar */
    .sidebar {
      display: none;
    }

    @media (min-width: 1024px) {
      .sidebar {
        display: block;
      }
    }

    .mobile-tabs {
      display: flex;
      overflow-x: auto;
      margin-bottom: 16px;
      gap: 8px;
      padding-bottom: 4px;
    }

    @media (min-width: 1024px) {
      .mobile-tabs {
        display: none;
      }
    }

    .tab {
      padding: 10px 16px;
      background: var(--glass-1);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      font-size: 14px;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .tab.active {
      background: rgba(255,122,24,0.1);
      border-color: rgba(255,122,24,0.3);
      color: var(--accent-light);
    }

    .sidebar-content {
      background: var(--glass-1);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 16px;
      backdrop-filter: blur(10px);
    }

    .search-box {
      position: relative;
      margin-bottom: 16px;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px 12px 40px;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 14px;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }

    .filter-section {
      margin-bottom: 20px;
    }

    .filter-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .filter-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background 0.2s;
    }

    .filter-option:hover {
      background: rgba(255,255,255,0.03);
    }

    .filter-option.active {
      background: rgba(255,122,24,0.1);
      color: var(--accent-light);
    }

    .filter-badge {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }

    .badge-common { background: #6b7280; }
    .badge-rare { background: #3b82f6; }
    .badge-epic { background: #8b5cf6; }
    .badge-legendary { background: #f59e0b; }

    /* Marketplace */
    .marketplace {
      flex: 1;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
    }

    .view-options {
      display: flex;
      gap: 8px;
    }

    .view-option {
      padding: 8px 12px;
      background: var(--glass-1);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      font-size: 13px;
    }

    .birds-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    @media (max-width: 640px) {
      .birds-grid {
        grid-template-columns: 1fr;
      }
    }

    .bird-card {
      background: var(--glass-1);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 16px;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .bird-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-2);
      border-color: rgba(255,122,24,0.3);
    }

    .bird-image {
      width: 100%;
      height: 140px;
      border-radius: var(--radius-md);
      background: linear-gradient(135deg, rgba(255,122,24,0.1), rgba(255,122,24,0.05));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      margin-bottom: 12px;
      position: relative;
    }

    .bird-rarity {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 8px;
      background: rgba(0,0,0,0.7);
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-weight: 600;
    }

    .bird-info {
      margin-bottom: 16px;
    }

    .bird-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .bird-description {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .bird-stats {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
    }

    .bird-price {
      font-weight: 700;
      color: var(--accent-light);
    }

    .bird-income {
      color: var(--success);
    }

    .bird-actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      flex: 1;
      text-align: center;
    }

    .btn-primary {
      background: var(--accent-gradient);
      color: #000;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-glow);
    }

    .btn-secondary {
      background: var(--glass-1);
      border: 1px solid var(--glass-border);
      color: var(--text-primary);
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 16px;
      backdrop-filter: blur(5px);
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-2);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-xl);
      padding: 24px;
      max-width: 400px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
    }

    .modal-body {
      margin-bottom: 24px;
    }

    .modal-bird-image {
      width: 100%;
      height: 160px;
      border-radius: var(--radius-md);
      background: linear-gradient(135deg, rgba(255,122,24,0.1), rgba(255,122,24,0.05));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 64px;
      margin-bottom: 16px;
    }

    .modal-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .detail-item {
      background: var(--glass-1);
      border-radius: var(--radius-md);
      padding: 12px;
      text-align: center;
    }

    .detail-value {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .detail-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Mobile Sidebar */
    .mobile-sidebar {
      position: fixed;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: var(--bg-2);
      z-index: 999;
      transition: left 0.3s ease;
      padding: 60px 20px 20px;
      overflow-y: auto;
    }

    .mobile-sidebar.active {
      left: 0;
    }

    .close-sidebar {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 24px;
    }

    /* Utility Classes */
    .text-accent { color: var(--accent-light); }
    .text-success { color: var(--success); }
    .text-muted { color: var(--text-muted); }
    .hidden { display: none; }

    /* Loading States */
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-3);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--glass-border);
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon">🐦</div>
        <div class="logo-text">
          <h1>CrowMRKT</h1>
          <p>Пассивный доход с птицами</p>
        </div>
      </div>
      
      <div class="user-profile">
        <img id="userAvatar" src="" alt="Avatar" class="user-avatar" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzNzM3MzciLz4KPHBhdGggZD0iTTIwIDIyQzIzLjMxMzcgMjIgMjYgMTkuMzEzNyAyNiAxNkMyNiAxMi42ODYzIDIzLjMxMzcgMTAgMjAgMTBDMTYuNjg2MyAxMCAxNCAxMi42ODYzIDE0IDE2QzE0IDE5LjMxMzcgMTYuNjg2MyAyMiAyMCAyMloiIGZpbGw9IiM2NjY2NjYiLz4KPHBhdGggZD0iTTI2LjUgMjhDMjYuNSAzMC40ODUzIDIzLjgxNDIgMzIgMjAgMzJDMTYuMTg1OCAzMiAxMy41IDMwLjQ4NTMgMTMuNSAyOEMxMy41IDI1LjUxNDcgMTYuMTg1OCAyNCAyMCAyNEMyMy44MTQyIDI0IDI2LjUgMjUuNTE0NyAyNi41IDI4WiIgZmlsbD0iIzY2NjY2NiIvPgo8L3N2Zz4K'">
        <div class="user-info">
          <div class="user-name" id="userName">Гость</div>
          <div class="user-handle" id="userHandle">@username</div>
        </div>
      </div>
    </div>
  </header>

  <!-- Mobile Tabs -->
  <div class="mobile-tabs">
    <button class="tab active" data-tab="market">Рынок</button>
    <button class="tab" data-tab="portfolio">Портфель</button>
    <button class="tab" data-tab="filters">Фильтры</button>
  </div>

  <!-- Main Content -->
  <div class="app-container">
    <!-- Stats Panel -->
    <div class="stats-panel">
      <div class="stat-card">
        <div class="stat-value" id="balance">0.00 Ꝑ</div>
        <div class="stat-label">Баланс</div>
      </div>
      <div class="stat-card income-stat">
        <div class="stat-value text-accent" id="dailyIncome">0.00 Ꝑ</div>
        <div class="stat-label">Доход в день</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="birdsCount">0</div>
        <div class="stat-label">Птиц в портфеле</div>
      </div>
      <div class="stat-card">
        <div class="stat-value text-success" id="totalEarned">0.00 Ꝑ</div>
        <div class="stat-label">Всего заработано</div>
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <!-- Desktop Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-content">
          <div class="search-box">
            <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path stroke="currentColor" stroke-width="2" stroke-linecap="round" d="M21 21l-4.35-4.35M11 6a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5z"/>
            </svg>
            <input type="text" class="search-input" id="searchInput" placeholder="Поиск птиц...">
          </div>

          <div class="filter-section">
            <div class="filter-title">Редкость</div>
            <div class="filter-options">
              <div class="filter-option active" data-rarity="all">
                <div class="filter-badge" style="background: var(--text-muted)"></div>
                <span>Все птицы</span>
              </div>
              <div class="filter-option" data-rarity="common">
                <div class="filter-badge badge-common"></div>
                <span>Обычные</span>
              </div>
              <div class="filter-option" data-rarity="rare">
                <div class="filter-badge badge-rare"></div>
                <span>Редкие</span>
              </div>
              <div class="filter-option" data-rarity="epic">
                <div class="filter-badge badge-epic"></div>
                <span>Эпические</span>
              </div>
              <div class="filter-option" data-rarity="legendary">
                <div class="filter-badge badge-legendary"></div>
                <span>Легендарные</span>
              </div>
            </div>
          </div>

          <div class="filter-section">
            <div class="filter-title">Сортировка</div>
            <div class="filter-options">
              <div class="filter-option active" data-sort="price-asc">
                <span>Цена: по возрастанию</span>
              </div>
              <div class="filter-option" data-sort="price-desc">
                <span>Цена: по убыванию</span>
              </div>
              <div class="filter-option" data-sort="income-desc">
                <span>Доход: высокий → низкий</span>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Mobile Sidebar -->
      <aside class="mobile-sidebar" id="mobileSidebar">
        <button class="close-sidebar" id="closeSidebar">×</button>
        <!-- Content same as desktop sidebar -->
        <div class="sidebar-content">
          <div class="search-box">
            <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path stroke="currentColor" stroke-width="2" stroke-linecap="round" d="M21 21l-4.35-4.35M11 6a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5z"/>
            </svg>
            <input type="text" class="search-input" id="mobileSearchInput" placeholder="Поиск птиц...">
          </div>

          <div class="filter-section">
            <div class="filter-title">Редкость</div>
            <div class="filter-options">
              <div class="filter-option active" data-rarity="all">
                <div class="filter-badge" style="background: var(--text-muted)"></div>
                <span>Все птицы</span>
              </div>
              <div class="filter-option" data-rarity="common">
                <div class="filter-badge badge-common"></div>
                <span>Обычные</span>
              </div>
              <div class="filter-option" data-rarity="rare">
                <div class="filter-badge badge-rare"></div>
                <span>Редкие</span>
              </div>
              <div class="filter-option" data-rarity="epic">
                <div class="filter-badge badge-epic"></div>
                <span>Эпические</span>
              </div>
              <div class="filter-option" data-rarity="legendary">
                <div class="filter-badge badge-legendary"></div>
                <span>Легендарные</span>
              </div>
            </div>
          </div>

          <div class="filter-section">
            <div class="filter-title">Сортировка</div>
            <div class="filter-options">
              <div class="filter-option active" data-sort="price-asc">
                <span>Цена: по возрастанию</span>
              </div>
              <div class="filter-option" data-sort="price-desc">
                <span>Цена: по убыванию</span>
              </div>
              <div class="filter-option" data-sort="income-desc">
                <span>Доход: высокий → низкий</span>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Marketplace -->
      <main class="marketplace">
        <div class="section-header">
          <h2 class="section-title" id="sectionTitle">Рынок птиц</h2>
          <div class="view-options">
            <button class="view-option" id="toggleFilters">Фильтры</button>
          </div>
        </div>

        <div class="birds-grid" id="birdsGrid">
          <!-- Birds will be loaded here -->
        </div>
      </main>
    </div>
  </div>

  <!-- Purchase Modal -->
  <div class="modal" id="purchaseModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Покупка птицы</h3>
        <button class="modal-close" id="closeModal">×</button>
      </div>
      <div class="modal-body">
        <div class="modal-bird-image" id="modalBirdImage">🐦</div>
        
        <h4 id="modalBirdName" style="margin-bottom: 8px;">Название птицы</h4>
        <p class="text-muted" id="modalBirdDescription" style="margin-bottom: 16px; font-size: 14px;">Описание птицы</p>
        
        <div class="modal-details">
          <div class="detail-item">
            <div class="detail-value text-accent" id="modalBirdPrice">0 Ꝑ</div>
            <div class="detail-label">Цена</div>
          </div>
          <div class="detail-item">
            <div class="detail-value text-success" id="modalBirdIncome">0 Ꝑ/день</div>
            <div class="detail-label">Доход</div>
          </div>
          <div class="detail-item">
            <div class="detail-value" id="modalBirdRarity">Обычная</div>
            <div class="detail-label">Редкость</div>
          </div>
          <div class="detail-item">
            <div class="detail-value" id="modalROI">0 дней</div>
            <div class="detail-label">Окупаемость</div>
          </div>
        </div>

        <div class="bird-actions">
          <button class="btn btn-secondary" id="cancelPurchase">Отмена</button>
          <button class="btn btn-primary" id="confirmPurchase">Купить</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Telegram WebApp Integration
    const tg = window.Telegram?.WebApp;
    
    // Mock data for birds
    const birdsData = [
      {id: 1, name: 'Грач-Основатель', rarity: 'epic', price: 120.00, dailyIncome: 6.40, emoji: '🪶', description: 'Надежная птица с стабильным доходом'},
      {id: 2, name: 'Полевой грач', rarity: 'common', price: 12.00, dailyIncome: 0.40, emoji: '🪶', description: 'Отличный выбор для начинающих'},
      {id: 3, name: 'Огненная цапля', rarity: 'rare', price: 55.00, dailyIncome: 2.10, emoji: '🔥', description: 'Приносит тепло и доход'},
      {id: 4, name: 'Ночная ворона', rarity: 'epic', price: 200.00, dailyIncome: 9.00, emoji: '🌙', description: 'Работает пока вы спите'},
      {id: 5, name: 'Серый певун', rarity: 'common', price: 9.00, dailyIncome: 0.28, emoji: '🎶', description: 'Маленькая птица с приятным доходом'},
      {id: 6, name: 'Золотой кроу', rarity: 'rare', price: 78.00, dailyIncome: 3.20, emoji: '✨', description: 'Блестящий источник дохода'},
      {id: 7, name: 'Болотный клекот', rarity: 'common', price: 15.00, dailyIncome: 0.55, emoji: '🌿', description: 'Неприхотливый работник'},
      {id: 8, name: 'Закатный ворон', rarity: 'rare', price: 64.00, dailyIncome: 2.55, emoji: '🌇', description: 'Лучший способ завершить день'},
      {id: 9, name: 'Императорский грач', rarity: 'epic', price: 350.00, dailyIncome: 17.8, emoji: '👑', description: 'Король пассивного дохода'},
      {id: 10, name: 'Легенда ветров', rarity: 'legendary', price: 800.00, dailyIncome: 45.0, emoji: '🌪️', description: 'Мифическая птица огромной силы'}
    ];

    // App state
    const state = {
      balance: 100.00,
      ownedBirds: [],
      totalEarned: 0,
      filters: {
        search: '',
        rarity: 'all',
        sort: 'price-asc'
      },
      currentTab: 'market',
      selectedBird: null
    };

    // DOM elements
    const elements = {
      userAvatar: document.getElementById('userAvatar'),
      userName: document.getElementById('userName'),
      userHandle: document.getElementById('userHandle'),
      balance: document.getElementById('balance'),
      dailyIncome: document.getElementById('dailyIncome'),
      birdsCount: document.getElementById('birdsCount'),
      totalEarned: document.getElementById('totalEarned'),
      birdsGrid: document.getElementById('birdsGrid'),
      searchInput: document.getElementById('searchInput'),
      mobileSearchInput: document.getElementById('mobileSearchInput'),
      purchaseModal: document.getElementById('purchaseModal'),
      closeModal: document.getElementById('closeModal'),
      cancelPurchase: document.getElementById('cancelPurchase'),
      confirmPurchase: document.getElementById('confirmPurchase'),
      modalBirdImage: document.getElementById('modalBirdImage'),
      modalBirdName: document.getElementById('modalBirdName'),
      modalBirdDescription: document.getElementById('modalBirdDescription'),
      modalBirdPrice: document.getElementById('modalBirdPrice'),
      modalBirdIncome: document.getElementById('modalBirdIncome'),
      modalBirdRarity: document.getElementById('modalBirdRarity'),
      modalROI: document.getElementById('modalROI'),
      toggleFilters: document.getElementById('toggleFilters'),
      mobileSidebar: document.getElementById('mobileSidebar'),
      closeSidebar: document.getElementById('closeSidebar'),
      sectionTitle: document.getElementById('sectionTitle'),
      tabs: document.querySelectorAll('.tab')
    };

    // Initialize Telegram WebApp
    function initTelegram() {
      if (tg) {
        tg.expand();
        tg.enableClosingConfirmation();
        
        // Set user data from Telegram
        const user = tg.initDataUnsafe?.user;
        if (user) {
          if (user.photo_url) {
            elements.userAvatar.src = user.photo_url;
          }
          elements.userName.textContent = user.first_name || 'Пользователь';
          elements.userHandle.textContent = user.username ? `@${user.username}` : '';
        }
      } else {
        // Fallback for development
        elements.userName.textContent = 'Демо-режим';
        elements.userHandle.textContent = '@demo';
      }
    }

    // Calculate daily income
    function calculateDailyIncome() {
      return state.ownedBirds.reduce((total, birdId) => {
        const bird = birdsData.find(b => b.id === birdId);
        return total + (bird ? bird.dailyIncome : 0);
      }, 0);
    }

    // Update UI with current state
    function updateUI() {
      const dailyIncome = calculateDailyIncome();
      
      elements.balance.textContent = state.balance.toFixed(2) + ' Ꝑ';
      elements.dailyIncome.textContent = dailyIncome.toFixed(2) + ' Ꝑ';
      elements.birdsCount.textContent = state.ownedBirds.length;
      elements.totalEarned.textContent = state.totalEarned.toFixed(2) + ' Ꝑ';
      
      renderBirdsGrid();
    }

    // Render birds grid based on filters
    function renderBirdsGrid() {
      let filteredBirds = birdsData.filter(bird => {
        // Filter by search
        if (state.filters.search && 
            !bird.name.toLowerCase().includes(state.filters.search.toLowerCase()) &&
            !bird.description.toLowerCase().includes(state.filters.search.toLowerCase())) {
          return false;
        }
        
        // Filter by rarity
        if (state.filters.rarity !== 'all' && bird.rarity !== state.filters.rarity) {
          return false;
        }
        
        return true;
      });
      
      // Sort birds
      filteredBirds.sort((a, b) => {
        switch (state.filters.sort) {
          case 'price-desc':
            return b.price - a.price;
          case 'income-desc':
            return b.dailyIncome - a.dailyIncome;
          case 'price-asc':
          default:
            return a.price - b.price;
        }
      });
      
      // Clear grid
      elements.birdsGrid.innerHTML = '';
      
      // Render birds
      filteredBirds.forEach(bird => {
        const isOwned = state.ownedBirds.includes(bird.id);
        const birdCard = document.createElement('div');
        birdCard.className = 'bird-card';
        birdCard.innerHTML = `
          <div class="bird-image">
            ${bird.emoji}
            <div class="bird-rarity">${getRarityLabel(bird.rarity)}</div>
          </div>
          <div class="bird-info">
            <div class="bird-name">${bird.name}</div>
            <div class="bird-description">${bird.description}</div>
            <div class="bird-stats">
              <div class="bird-price">${bird.price.toFixed(2)} Ꝑ</div>
              <div class="bird-income">+${bird.dailyIncome.toFixed(2)} Ꝑ/день</div>
            </div>
          </div>
          <div class="bird-actions">
            ${isOwned ? 
              '<button class="btn btn-secondary" disabled>Уже куплена</button>' :
              `<button class="btn btn-primary" data-bird-id="${bird.id}">Купить</button>`
            }
          </div>
        `;
        elements.birdsGrid.appendChild(birdCard);
      });
      
      // Add event listeners to buy buttons
      document.querySelectorAll('.btn-primary').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const birdId = parseInt(e.target.dataset.birdId);
          openPurchaseModal(birdId);
        });
      });
    }

    // Get Russian label for rarity
    function getRarityLabel(rarity) {
      const labels = {
        common: 'Обычная',
        rare: 'Редкая',
        epic: 'Эпическая',
        legendary: 'Легендарная'
      };
      return labels[rarity] || rarity;
    }

    // Open purchase modal
    function openPurchaseModal(birdId) {
      const bird = birdsData.find(b => b.id === birdId);
      if (!bird) return;
      
      state.selectedBird = bird;
      
      elements.modalBirdImage.textContent = bird.emoji;
      elements.modalBirdName.textContent = bird.name;
      elements.modalBirdDescription.textContent = bird.description;
      elements.modalBirdPrice.textContent = bird.price.toFixed(2) + ' Ꝑ';
      elements.modalBirdIncome.textContent = '+' + bird.dailyIncome.toFixed(2) + ' Ꝑ/день';
      elements.modalBirdRarity.textContent = getRarityLabel(bird.rarity);
      
      // Calculate ROI (return on investment)
      const roi = Math.ceil(bird.price / bird.dailyIncome);
      elements.modalROI.textContent = `${roi} дней`;
      
      elements.purchaseModal.classList.add('active');
    }

    // Close purchase modal
    function closePurchaseModal() {
      elements.purchaseModal.classList.remove('active');
      state.selectedBird = null;
    }

    // Handle bird purchase
    function purchaseBird() {
      if (!state.selectedBird) return;
      
      const bird = state.selectedBird;
      
      if (state.balance < bird.price) {
        alert('Недостаточно средств для покупки этой птицы!');
        return;
      }
      
      if (state.ownedBirds.includes(bird.id)) {
        alert('Эта птица уже есть в вашем портфеле!');
        return;
      }
      
      // Process purchase
      state.balance -= bird.price;
      state.ownedBirds.push(bird.id);
      
      // Give small bonus for purchase
      const bonus = bird.dailyIncome * 0.5;
      state.totalEarned += bonus;
      
      updateUI();
      closePurchaseModal();
      
      // Show success message
      if (tg && tg.showPopup) {
        tg.showPopup({
          title: 'Покупка успешна!',
          message: `Вы приобрели ${bird.name}! Доход: +${bird.dailyIncome.toFixed(2)} Ꝑ/день`,
          buttons: [{type: 'ok'}]
        });
      } else {
        alert(`Поздравляем! Вы приобрели ${bird.name}!`);
      }
    }

    // Initialize filters
    function initFilters() {
      // Search functionality
      elements.searchInput.addEventListener('input', (e) => {
        state.filters.search = e.target.value;
        renderBirdsGrid();
      });
      
      elements.mobileSearchInput.addEventListener('input', (e) => {
        state.filters.search = e.target.value;
        renderBirdsGrid();
      });
      
      // Rarity filters
      document.querySelectorAll('.filter-option[data-rarity]').forEach(option => {
        option.addEventListener('click', (e) => {
          document.querySelectorAll('.filter-option[data-rarity]').forEach(opt => {
            opt.classList.remove('active');
          });
          e.currentTarget.classList.add('active');
          
          state.filters.rarity = e.currentTarget.dataset.rarity;
          renderBirdsGrid();
        });
      });
      
      // Sort filters
      document.querySelectorAll('.filter-option[data-sort]').forEach(option => {
        option.addEventListener('click', (e) => {
          document.querySelectorAll('.filter-option[data-sort]').forEach(opt => {
            opt.classList.remove('active');
          });
          e.currentTarget.classList.add('active');
          
          state.filters.sort = e.currentTarget.dataset.sort;
          renderBirdsGrid();
        });
      });
    }

    // Initialize mobile functionality
    function initMobile() {
      // Toggle filters sidebar
      elements.toggleFilters.addEventListener('click', () => {
        elements.mobileSidebar.classList.add('active');
      });
      
      // Close sidebar
      elements.closeSidebar.addEventListener('click', () => {
        elements.mobileSidebar.classList.remove('active');
      });
      
      // Tab switching
      elements.tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
          elements.tabs.forEach(t => t.classList.remove('active'));
          e.currentTarget.classList.add('active');
          
          state.currentTab = e.currentTarget.dataset.tab;
          elements.sectionTitle.textContent = getTabTitle(state.currentTab);
          
          // For demo purposes, just change the title
          // In a real app, you would load different content
        });
      });
    }

    // Get tab title
    function getTabTitle(tab) {
      const titles = {
        market: 'Рынок птиц',
        portfolio: 'Мой портфель',
        filters: 'Фильтры'
      };
      return titles[tab] || 'Рынок птиц';
    }

    // Simulate passive income
    function startIncomeSimulation() {
      setInterval(() => {
        const dailyIncome = calculateDailyIncome();
        const perSecond = dailyIncome / 86400; // Daily income per second
        
        state.balance += perSecond;
        state.totalEarned += perSecond;
        
        // Update balance display more frequently for smooth animation
        elements.balance.textContent = state.balance.toFixed(2) + ' Ꝑ';
        elements.totalEarned.textContent = state.totalEarned.toFixed(2) + ' Ꝑ';
      }, 1000);
    }

    // Initialize app
    function initApp() {
      initTelegram();
      initFilters();
      initMobile();
      updateUI();
      startIncomeSimulation();
      
      // Modal event listeners
      elements.closeModal.addEventListener('click', closePurchaseModal);
      elements.cancelPurchase.addEventListener('click', closePurchaseModal);
      elements.confirmPurchase.addEventListener('click', purchaseBird);
      
      // Close modal on backdrop click
      elements.purchaseModal.addEventListener('click', (e) => {
        if (e.target === elements.purchaseModal) {
          closePurchaseModal();
        }
      });
    }

    // Start the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
